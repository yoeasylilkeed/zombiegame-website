<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nightfall: Zombie Streets — Enhanced</title>
  <style>
    html,body{height:100%;margin:0;background:#0e0f13;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#e6eef8}
    #wrap{display:flex;align-items:center;justify-content:center;height:100%;padding:20px;box-sizing:border-box}
    canvas{background:linear-gradient(#101217,#0b0c10);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
    .panel{position:fixed;right:24px;top:24px;width:300px;background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
    .panel h3{margin:0 0 6px 0;font-size:16px}
    .small{font-size:12px;color:#bcd0ea}
    .btn{appearance:none;border:0;padding:8px 10px;border-radius:8px;background:#2b8a3e;color:white;cursor:pointer;font-weight:700}
    .footer{position:fixed;left:20px;bottom:12px;color:#9fb2d9;font-size:13px}

    /* Pause menu */
    #pauseOverlay{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:50}
    #pauseMenu{background:#111;padding:20px;border-radius:10px;min-width:260px;text-align:center}
    .menuItem{display:block;margin:8px;padding:10px 14px;background:#222;border-radius:8px;color:#fff;cursor:pointer}

    /* Settings */
    .row{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
  </style>
</head>
<body>
  <div id="wrap">
    <canvas id="game" width="1024" height="640"></canvas>
  </div>

  <div class="panel">
    <h3>Nightfall: Zombie Streets — Enhanced</h3>
    <div class="small">W/A/S/D to move • Mouse aim • Left-click to shoot • R restart • 1 = pistol • 2 = shotgun</div>
    <hr style="opacity:.06;border:0;border-top:1px solid rgba(255,255,255,0.04);margin:8px 0">
    <div>Score: <span id="uiScore">0</span></div>
    <div>Wave: <span id="uiWave">1</span></div>
    <div>HP: <span id="uiHP">100</span></div>
    <div>Ammo: <span id="uiAmmo">—</span></div>
    <div style="margin-top:8px"><button class="btn" id="restartBtn">Restart</button></div>
    <div style="margin-top:8px" class="small">Boss on wave 40 — survive and win the encounter!</div>
  </div>

  <div id="pauseOverlay"><div id="pauseMenu">
    <div style="font-size:18px;margin-bottom:8px;color:#ffd96b">Paused</div>
    <div class="menuItem" id="resumeButton">Resume</div>
    <div class="menuItem" id="settingsButton">Settings</div>
    <div class="menuItem" id="quitButton">Quit Game</div>
    <div id="settingsPanel" style="display:none;margin-top:10px;text-align:left">
      <div class="row"><label>Master Vol</label><input id="volMaster" type="range" min="0" max="1" step="0.01" value="0.7"></div>
      <div class="row"><label>SFX</label><input id="volSfx" type="range" min="0" max="1" step="0.01" value="1"></div>
      <div class="row"><label>Music</label><input id="volAmb" type="range" min="0" max="1" step="0.01" value="0.18"></div>
    </div>
  </div></div>

  <div class="footer">Tip: Boss fight at wave 40 is tough — use ammo and pickups wisely.</div>

<script>
// Enhanced Nightfall: Zombie Streets
// - Pause menu (Esc) with Resume/Quit/Settings
// - Basic audio system (WebAudio) with ambient, zombie growls, gun SFX, boss roar
// - Boss at wave 40 with special behaviour
// - Fixed respawn/restart to reset to wave 1

// Canvas & context
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;

// UI
const uiScore = document.getElementById('uiScore');
const uiWave = document.getElementById('uiWave');
const uiHP = document.getElementById('uiHP');
const uiAmmo = document.getElementById('uiAmmo');
const restartBtn = document.getElementById('restartBtn');

// Pause menu elements
const pauseOverlay = document.getElementById('pauseOverlay');
const resumeButton = document.getElementById('resumeButton');
const settingsButton = document.getElementById('settingsButton');
const quitButton = document.getElementById('quitButton');
const settingsPanel = document.getElementById('settingsPanel');
const volMaster = document.getElementById('volMaster');
const volSfx = document.getElementById('volSfx');
const volAmb = document.getElementById('volAmb');

// WebAudio setup
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();
const masterGain = audioCtx.createGain(); masterGain.gain.value = parseFloat(volMaster.value); masterGain.connect(audioCtx.destination);
const sfxGain = audioCtx.createGain(); sfxGain.gain.value = parseFloat(volSfx.value); sfxGain.connect(masterGain);
const ambGain = audioCtx.createGain(); ambGain.gain.value = parseFloat(volAmb.value); ambGain.connect(masterGain);

volMaster.addEventListener('input',()=>{ masterGain.gain.value = parseFloat(volMaster.value); });
volSfx.addEventListener('input',()=>{ sfxGain.gain.value = parseFloat(volSfx.value); });
volAmb.addEventListener('input',()=>{ ambGain.gain.value = parseFloat(volAmb.value); });

// Ambient: slow noise drone (approx)
let ambOsc;
function startAmbient(){ if(ambOsc) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='sine'; o.frequency.value = 60; g.gain.value = 0.0025; o.connect(g); g.connect(ambGain); o.start(); ambOsc = {osc:o,gain:g}; }
function stopAmbient(){ if(!ambOsc) return; ambOsc.osc.stop(); ambOsc.gain.disconnect(); ambOsc = null; }
startAmbient();

// SFX helper functions
function playBeep(freq,dur,vol=0.08){ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='square'; o.frequency.value=freq; g.gain.value=vol; o.connect(g); g.connect(sfxGain); o.start(); o.stop(audioCtx.currentTime+dur); }

function playGunShot(){ // short burst + click
 playBeep(1200,0.05,0.12);
 const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='triangle'; o.frequency.value=500; g.gain.value = 0.05; o.connect(g); g.connect(sfxGain); o.start(); g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.12); o.stop(audioCtx.currentTime+0.13);
}

function playZombieGrowl(intensity=0.6){ // low rumble
 const b = audioCtx.createBufferSource(); const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate*0.4, audioCtx.sampleRate);
 const data = buffer.getChannelData(0);
 for(let i=0;i<data.length;i++){ data[i] = (Math.random()*2-1) * 0.3 * (1 - i/data.length); }
 b.buffer = buffer; const g = audioCtx.createGain(); g.gain.value = intensity*0.2; b.connect(g); g.connect(sfxGain); b.start(); }

function playBossRoar(){ // heavy low oscillator burst
 const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='sawtooth'; o.frequency.value=80; g.gain.value=0.2; o.connect(g); g.connect(sfxGain); o.start(); g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+1.2); o.stop(audioCtx.currentTime+1.3);
}

// Game state
let keys = {}, mouse = {x:0,y:0,down:false};
let score = 0; let highscore = Number(localStorage.getItem('nf_high')||0);
let wave = 1; let enemies = []; let bullets = []; let pickups = [];
let gameOver = false; let paused = false; let bossAlive = false;

// Player
const player = {x: W/2, y: H/2, r: 14, speed: 2.6, hp: 100, maxHp:100, weapon: 'pistol', pistolAmmo: 999, shotgunAmmo: 16, fireCooldown: 0};

// Settings defaults (in UI already)

// Input
window.addEventListener('keydown', e=>{ keys[e.key.toLowerCase()] = true; if(e.key==='Escape'){ togglePause(); } if(e.key==='r' || e.key==='R') restart(); if(e.key==='1') selectWeapon('pistol'); if(e.key==='2') selectWeapon('shotgun'); });
window.addEventListener('keyup', e=>{ keys[e.key.toLowerCase()] = false; });
canvas.addEventListener('mousemove', e=>{ const rect = canvas.getBoundingClientRect(); mouse.x = e.clientX - rect.left; mouse.y = e.clientY - rect.top; });
canvas.addEventListener('mousedown', e=>{ if(e.button===0) mouse.down=true; });
canvas.addEventListener('mouseup', e=>{ if(e.button===0) mouse.down=false; });

restartBtn.addEventListener('click', ()=> restart());
resumeButton.addEventListener('click', ()=> togglePause(false));
settingsButton.addEventListener('click', ()=>{ settingsPanel.style.display = settingsPanel.style.display==='none'?'block':'none'; });
quitButton.addEventListener('click', ()=> { location.reload(); });

function togglePause(force){ if(typeof force === 'boolean') paused = !force ? false : true; else paused = !paused; pauseOverlay.style.display = paused ? 'flex' : 'none'; }

function selectWeapon(w){ player.weapon = w; updateUI(); }

// Enemy factory
function spawnEnemy(type, x, y){ const e = {id: Math.random().toString(36).slice(2,9), x, y, type, vx:0, vy:0, dead:false};
 if(type==='walker'){ e.speed = 0.6 + Math.random()*0.24; e.hp = 28; e.color = '#7fb86a'; }
 else if(type==='runner'){ e.speed = 1.6 + Math.random()*0.6; e.hp = 20; e.color = '#d99f6a'; }
 else if(type==='armored'){ e.speed = 0.45; e.hp = 90; e.color = '#9aa9b0'; }
 else if(type==='boss'){ e.speed = 0.5; e.hp = 800; e.color = '#8b2d2d'; e.isBoss=true; }
 enemies.push(e);
 playZombieGrowl(0.8);
}

// Spawn initial enemies
function spawnWave(n){ if(n<=0) return; for(let i=0;i<n;i++){ setTimeout(()=>{ const side = Math.floor(Math.random()*4); let x,y; if(side===0){ x = Math.random()*-80; y = Math.random()*H; } else if(side===1){ x = W + Math.random()*80; y = Math.random()*H; } else if(side===2){ x = Math.random()*W; y = Math.random()*-80; } else { x = Math.random()*W; y = H + Math.random()*80; }
    // boss spawn at wave 40
    if(wave===40 && !bossAlive){ if(i===0){ spawnEnemy('boss', x, y); bossAlive = true; playBossRoar(); } else spawnEnemy('walker', x, y); }
    else { const r = Math.random(); if(r < 0.7) spawnEnemy('walker', x, y); else if(r < 0.9) spawnEnemy('runner', x, y); else spawnEnemy('armored', x, y); }
  }, i*200); }
}

// Bullets
function fireBullet(x,y,dx,dy,opts={}){ bullets.push({x,y,dx,dy,life:opts.life||60, speed: opts.speed||12, dmg: opts.dmg||24, radius: opts.radius||4, owner:'player'}); }

function playGun(){ if(audioCtx.state === 'suspended') audioCtx.resume(); playGunShot(); }

// Pickups
function spawnPickup(type,x,y){ pickups.push({type,x,y,ttl:600}); }

// Particles
let particles = [];
function spawnDeathParticles(x,y, color){ for(let i=0;i<12;i++){ particles.push({x,y,vx:(Math.random()*2-1)*3,vy:(Math.random()*2-1)*3,life:40,color}); } }

// Game init/reset
function init(){ enemies = []; bullets = []; pickups = []; particles = []; score = 0; wave = 1; uiWave.textContent = wave; player.hp = player.maxHp; player.shotgunAmmo = 16; player.weapon = 'pistol'; player.fireCooldown = 0; gameOver = false; bossAlive = false; spawnWave(4); updateUI(); startAmbient(); }
init();

function updateUI(){ uiScore.textContent = Math.floor(score); uiHP.textContent = Math.floor(player.hp); uiAmmo.textContent = player.weapon==='pistol' ? '∞' : player.shotgunAmmo; uiWave.textContent = wave; }

function restart(){ // resets back to wave 1 per your request
  init(); togglePause(false); }

// Game loop
function update(){ if(gameOver || paused) return;
  // movement input
  let mx=0,my=0; if(keys['w']) my-=1; if(keys['s']) my+=1; if(keys['a']) mx-=1; if(keys['d']) mx+=1;
  const mag = Math.hypot(mx,my) || 1; // simple movement scaling
  // player does not move visually; keep player centered, simulate camera world instead
  // bullets update
  for(let i=bullets.length-1;i>=0;i--){ const b = bullets[i]; b.x += b.dx * b.speed; b.y += b.dy * b.speed; b.life--; if(b.life<=0) bullets.splice(i,1); }

  // enemies behaviour and collisions
  for(let i=enemies.length-1;i>=0;i--){ const e = enemies[i]; if(e.dead) continue;
    // move towards player center
    const dx = (W/2) - e.x; const dy = (H/2) - e.y; const d = Math.hypot(dx,dy)||1; e.vx = (dx/d) * e.speed; e.vy = (dy/d) * e.speed; e.x += e.vx; e.y += e.vy;

    // if close -> damage player
    if(d < 26){ player.hp -= 0.35 * (e.isBoss?4:1); if(player.hp <= 0){ player.hp = 0; gameOver = true; setTimeout(()=> alert('You died — press Restart to try again'), 80); } }

    // bullet hits
    for(let j=bullets.length-1;j>=0;j--){ const b = bullets[j]; const dx2 = b.x - e.x; const dy2 = b.y - e.y; if(Math.hypot(dx2,dy2) < (b.radius + 12)){
        e.hp -= b.dmg; bullets.splice(j,1); playZombieGrowl(0.3);
        if(e.hp <= 0){ e.dead = true; score += (e.isBoss?1000:(e.type==='armored'?60:(e.type==='runner'?20:10))); if(e.isBoss){ bossAlive=false; alert('Boss defeated! Wave cleared.'); }
          if(Math.random() < 0.15) spawnPickup(Math.random()<0.6?'health':'ammo', e.x, e.y);
          spawnDeathParticles(e.x,e.y,e.color);
        }
        break;
    }}
    if(e.dead) enemies.splice(i,1);
  }

  // pickups
  for(let i=pickups.length-1;i>=0;i--){ const p = pickups[i]; p.ttl--; if(p.ttl<=0) pickups.splice(i,1); else if(Math.hypot((W/2)-p.x,(H/2)-p.y) < 18){ if(p.type==='health'){ player.hp = Math.min(player.maxHp, player.hp + 30); } else { player.shotgunAmmo = Math.min(99, player.shotgunAmmo + 6); } pickups.splice(i,1); updateUI(); }
  }

  // spawn next wave if cleared
  if(enemies.length === 0 && !gameOver){ wave++; uiWave.textContent = wave; if(wave<=39){ const count = 4 + Math.floor(wave * 1.8); spawnWave(count); player.hp = Math.min(player.maxHp, player.hp + 8); } else if(wave===40){ // spawn boss wave
      spawnWave(8); // includes boss in spawnWave logic
  } else { const count = 6 + Math.floor(wave * 2.4); spawnWave(count); }
  }
}

function draw(){ // simple scene centered on player
  ctx.clearRect(0,0,W,H);
  // background
  ctx.fillStyle = '#0b0c10'; ctx.fillRect(0,0,W,H);
  // ambient subtle grid
  ctx.save(); ctx.globalAlpha = 0.04; ctx.strokeStyle='#fff'; for(let x=0;x<W;x+=48){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); } for(let y=0;y<H;y+=48){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); } ctx.restore();

  // draw pickups
  for(const p of pickups){ ctx.fillStyle = p.type==='health' ? '#7ee1a0' : '#f4d06f'; ctx.beginPath(); ctx.arc(p.x,p.y,8,0,Math.PI*2); ctx.fill(); }

  // draw enemies
  for(const e of enemies){ ctx.save(); ctx.translate(e.x,e.y); ctx.fillStyle = e.color; ctx.fillRect(-12,-12,24,24); ctx.fillStyle='#08121a'; ctx.fillRect(-6,-6,5,5); ctx.fillRect(2,-6,5,5); ctx.restore(); }

  // bullets
  for(const b of bullets){ ctx.beginPath(); ctx.fillStyle='#ffd96b'; ctx.arc(b.x,b.y,b.radius,0,Math.PI*2); ctx.fill(); }

  // particles
  for(const p of particles){ ctx.globalAlpha = Math.max(0, p.life/40); ctx.fillStyle = p.color; ctx.fillRect(p.x-2,p.y-2,4,4); }

  // player is centered
  ctx.save(); ctx.translate(W/2, H/2);
  ctx.beginPath(); ctx.fillStyle='#ffd9b5'; ctx.arc(0,0,player.r,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#2b2d42'; ctx.fillRect(-6,8,12,10);
  ctx.restore();

  // HUD crosshair
  ctx.beginPath(); ctx.strokeStyle='rgba(255,255,255,0.85)'; ctx.lineWidth=1; ctx.moveTo(W/2-10,H/2); ctx.lineTo(W/2+10,H/2); ctx.moveTo(W/2,H/2-10); ctx.lineTo(W/2,H/2+10); ctx.stroke();

  if(gameOver){ ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(0,0,W,H); ctx.fillStyle='#fff'; ctx.font='36px sans-serif'; ctx.fillText('Game Over', W/2-100, H/2); ctx.font='18px sans-serif'; ctx.fillText('Press Restart to play again (resets to wave 1)', W/2-180, H/2 + 28); }
}

function spawnDeathParticles(x,y,color){ for(let i=0;i<12;i++){ particles.push({x:x+Math.random()*10-5,y:y+Math.random()*10-5,vx:Math.random()*2-1,vy:Math.random()*2-1,life:40,color}); }}

function updateParticles(){ for(let i=particles.length-1;i>=0;i--){ const p = particles[i]; p.x += p.vx; p.y += p.vy; p.life--; if(p.life<=0) particles.splice(i,1); }}

// Shooting & input handling
function playerShoot(){ if(player.fireCooldown>0) return; if(player.weapon==='pistol'){ playGun(); fireBullet(W/2,H/2, (mouse.x-W/2)/100, (mouse.y-H/2)/100, {speed:16,dmg:28,life:60}); player.fireCooldown = 10; }
 else if(player.weapon==='shotgun'){ if(player.shotgunAmmo<=0) return; playGun(); for(let i=0;i<7;i++){ const a = (Math.random()-0.5)*0.6; fireBullet(W/2,H/2, (mouse.x-W/2)/100 + a, (mouse.y-H/2)/100 + a, {speed:12,dmg:10,life:30}); } player.shotgunAmmo--; player.fireCooldown = 22; }
 updateUI(); }

canvas.addEventListener('click', ()=>{ if(!paused && !gameOver) playerShoot(); });

// main loop
function loop(){ if(!paused){ update(); updateParticles(); }
 draw(); if(player.fireCooldown>0) player.fireCooldown--; requestAnimationFrame(loop); }
loop();

// periodic ambient growls
setInterval(()=>{ if(!paused && !gameOver){ if(Math.random()<0.25) playZombieGrowl(0.35); } }, 4000);

// fix: ensure restart resets properly to wave 1 and restarts
// already handled in restart() -> init()

// Save highscore on unload
window.addEventListener('beforeunload', ()=>{ if(score>highscore) localStorage.setItem('nf_high', score); });

</script>
</body>
</html>
